<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Experimenting with ActivityPub: Minetest ActivityPub Bridge</title>
		<meta name="description" content="Blog about things">
		<link rel="webmention" href="https://webmention.io/tomcasavant.com/webmention" />
		<link rel="alternate" href="/blog.xml" type="application/rss+xml" title="Tom Casavant">
		<link rel="alternate" href="/feed.json" type="application/json" title="Tom Casavant">
		<link rel="blogroll" type="text/xml" href="/subscriptions.opml">

		<link rel="icon" type="image/png" sizes="32x32" href="/img/favicons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/img/favicons/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/img/favicons/apple-touch-icon.png">
		<link rel="manifest" href="/img/favicons/site.webmanifest">
		<link rel="mask-icon" href="/img/favicons/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileImage" content="/img/favicons/mstile-150x150.png">
		<meta name="theme-color" content="#ffffff">
		<meta name="fediverse:creator" content="@tom@tomkahe.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Lato:wght@300&display=swap" rel="stylesheet"><style data-href='https://fonts.googleapis.com/css2?family=Lato:wght@300&display=swap'>/* latin-ext */
@font-face {
  font-family: 'Lato';
  font-style: normal;
  font-weight: 300;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/lato/v24/S6u9w4BMUTPHh7USSwaPGQ3q5d0N7w.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Lato';
  font-style: normal;
  font-weight: 300;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/lato/v24/S6u9w4BMUTPHh7USSwiPGQ3q5d0.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>
		
		<link
			href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css"
			rel="stylesheet"
		/>
		<style>* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors 
:root {
	--color-gray-20: #BAB2B5;
	--color-gray-50: #123C69;
	--color-gray-90: #AC3B61;

	--background-color: #EDC7B7;
	--background-standout: #DDB7A7;
	--highlight-color: rgba(0, 0, 0, 0.6);
	--alternating-rows: #DCB6A6;

	--text-color: var(--color-gray-90);
	--text-color-link: #AC3B61;
	--text-color-link-active: #2E3944;
	--text-color-link-visited: #DD3B61;

	--syntax-tab-size: 2;
}*/

/*@media (prefers-color-scheme: dark) {*/
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #A0A0A0;
		--color-gray-90: #dad8d8;

		--background-color: #121212;
		--background-standout: #242120;
		--highlight-color: rgba(255,255,255,0.6);
		--alternating-rows: #473e3a;
		
		--text-color: var(--color-gray-50);
		--text-color-link: #DD3B61;
		--text-color-link-active: #9E9994;
		--text-color-link-visited: #DD3B61;

		/* --text-color is assigned to --color-gray-_ above 
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;*/
	}
/*}*/


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 60em;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.75;
}

li {
	line-height: 1.75;
}

a[href] {
	color: var(--text-color-link);
}

a[href]:visited{
    color: var(--text-color-link-visited);
}

a[href]:hover,
a[href]:active {
    color: var(--text-color-link-active);
}


main {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}
table {
    margin-left: auto;
    margin-right: auto;
    text-align: center;
}
table th, table td {
    text-align: center;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 0.8em;
}
.home-link {
	font-size: 1.3em; /* 16px /16 */
	font-weight: 710;
	margin-right: 1em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: inline-block;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
	font-size:1.1em;
	font-weight:500;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
	position: relative;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
	border: 1px solid #000;
	text-align: center;
	position: relative;
	padding-bottom: 2.5em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	/*content: "" counter(start-from, decimal-leading-zero) ". ";*/
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 1em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
	flex-basis: calc(100% - 1.5rem);
}
.postlist-link {
	font-size: 1.6em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-subtitle {
	font-size: 1em;
	font-weight: 400;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-align: center;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	font-style: italic;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-metadata time {
	margin-right: 1em;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

.bookmark {
	background-color: var(--background-standout);
	border: 1px solid #000;
	box-shaddow: 2px 2px 5px rgba(0, 0, 0, 0.2);
}

.bookmark-title {
	text-align: center;
}

.bookmark-summary {
	text-align: center;
	font-size: 0.75em;
}

.activities {
    border: 0.1px solid;
    width: 100%;
    border-collapse: collapse;
    font-family: 'Lato', normal;
}

.activities-header {
    text-align: left;
}

.activities tr:nth-child(even) {
    background-color: var(--alternating-rows);
}

profile-image {
	width: 0.1em;
	height: 0.1em;
}

.message-box {
    display: flex;
    justify-content: center; /* Center the icons horizontally */
    align-items: center; /* Center the icons vertically */
}

.icon {
    width: 24px; 
    height: 24px; 
    margin-right: 8px; 
    fill: currentColor; 
}

.bluesky-icon {
    transform: translateY(1px) scale(1.1); 
}
.rss-icon {
    transform: translateY(1px) scale(1.1); 
}
.github-icon {
    transform: scale(1.1); 
}
.ipod-icon {
  transform: translateY(1.5px) scale(1.5);
}

.post-icon {
  position: absolute;
  top: 0;
  right: 0;
  margin: 5px;
  color: var(--text-color-link-visited);
}


.message-box svg {
    display: block;
    vertical-align: middle;
}

.message-box svg:last-child {
    margin-right: 0; /* Remove margin from the last icon */
}

.image-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: 1fr 1fr; /* 2 rows */
  grid-gap: 10px;
}

.image-item {
  width: 100%;
  height: 0;
  padding-top: 200%; /* Maintain aspect ratio (2:1) for portrait-oriented images */
  position: relative;
  overflow: hidden;
}

.image-item img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

a.microblog-post-link {
  text-decoration: none;
  color: inherit;
  display: block;
}

.microblog-post {
  position: relative;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
  background-color: transparent;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: box-shadow 0.2s ease;
}

.microblog-post:hover {
  box-shadow: 0 4px 8px var(--highlight-color);
}

.microblog-post .post-description,
.microblog-post .post-date {
  font-size: 0.85em;
  margin: 8px 0;
  color: #666;
  text-decoration: none;
}

.microblog-post .post-date {
  font-size: 0.575em;
  color: #999;
  text-align: right;
}

.microblog-post .post-media {
  max-width: 100%;
  height: auto;
  margin-top: 16px;
  border-radius: 4px;
}

.video-container {
  position: relative;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  height: 0;
  overflow: hidden;
  max-width: 100%;
  background: #000;
}

.video-container video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

picture {
  display: block;
  max-width: 100%;
  overflow: hidden;
}

picture img {
  display: block;
  max-width: 100%;
  height: auto;
}

/* Webmentions */
.webmentions img {
  border-radius: 50%;
  display: inline;
  height: 48px;
  width: 48px;
  object-fit: cover;
}
.webmentions h3 {margin-top: 40px;}
.webmentions__facepile span {
  font-size: var(--size-600);
  margin-right: 2rem;
}
.webmention-replies img {
  height: 24px;
  width: 24px;}
.webmention-replies article {margin-bottom: 32px;}
.webmention-replies .webmention__meta {margin-bottom: 8px;}
.webmention-replies .webmention__meta time {display: block; margin-top: 8px;}
.webmention-text {font-size: var(--size-400); margin-top: 0;}
.webmention-text a {font-size: var(--size-300); margin-left: 4px;}
article.webmention {
  background-color: var(--grey-05);
  padding: 16px 16px 12px;
}
form input[type="url"] {
  display: block;
  height: 2rem;
  width: 100%;}
.form-webmention {
  display: grid;
  grid-template-columns: auto;
  gap: 8px;
  margin: 16px 0;
  width: 100%;}
.form-webmention input {width: 100%;}
.form-webmention .button {
  font-size: var(--size-300);
  height: 2rem;}
form label {
  font-weight: 600;
  margin: 4px 0 0 0;}
.form {
  background-color: var(--grey-05);
  margin: 40px auto;
  padding: 16px;
  position: relative;}
.form > * {position: relative;}
.form svg {
  position: absolute;
  top: 5px;
  right: 10px;}
.form button, .form label, .form p {
  display: block;
  margin: 24px auto;
  width: 90%;}
.form input {
  height: 2rem;}
.form input, .form textarea {
  border: 1px solid var(--grey-20);
  color: var(--grey-80);
  display: block;
  font-family: var(--font-body);
  font-size: var(--size-400);
  font-weight: 400;
  margin: 4px 0;
  padding: 4px;
  width: 100%;}
footer .form {
  background: none;
  box-shadow: none;
  text-align: left;
}
footer .button {
  font-size: var(--size-400);
  padding: 8px 12px;
}
footer .form input, footer .form button {
  height: 2.3rem;
}
#honey {display: none;}
.well {
  background-color: rgba(222,221,227,0.4);
  margin-top: 40px;
  overflow: hidden;
  padding: 32px;
  position: relative;}
.well > * {position: relative;}
.well svg {
  bottom: 0;
  right: 100px;
  position: absolute;
  transform: rotate(45deg);}
.tmpl-newspost .circles .content-780 {
  margin: 0 auto;
}

.postlist-webmentions {
    display: flex;
    gap: 0.5em;
    justify-content: flex-end; /* Aligns items to the right */
    position: absolute;
    right: 0.5em;
    bottom: 0;
}

.postlist-webmentions .heart-icon {
    margin-right: 0.2em
}

.postlist-webmentions #retweet-round {
    margin-right: 0.35em
}

.postlist-webmentions svg {
    width: 1rem;
    height: 1rem;
    display: inline-block;
    vertical-align: middle;
    fill: var(--text-color-link); 
    stroke: var(--text-color-link);
}

.webmention-count {
    display: inline-block;
    vertical-align: middle;
    margin-left: 0.05rem;
    font-size: 0.85rem;
    color: var(--text-color-link);
    transform: translateY(-0.5em);
}

.webmention-item {
    display: flex;
    align-items: center;
    gap: 0.01rem;
}

/* Media Query for Smaller Screens */
@media (max-width: 768px) {
  .timeline-container {
    flex-direction: column; /* Stack items vertically */
    padding: 10px; /* Reduce padding on smaller screens */
  }

  .timeline {
    margin: 0 auto; /* Center the timeline */
    width: 100%; /* Make the timeline take up the full width */
  }
}

/* Media Query for Even Smaller Screens */
@media (max-width: 480px) {
  .timeline-container {
    padding: 5px; /* Further reduce padding on very small screens */
  }

  .timeline {
    margin: 0; /* Remove margins */
    width: 100%; /* Ensure it takes up the full width */
  }
}

/* Outer Layer with the timeline border */
.outer {
  border-left: 2px solid #333;
}

/* Card container */
.card {
  position: relative;
  margin: 0 0 20px 20px;
  padding: 10px;
  background: var(--background-standout);
  color: var(--text-color);
  border-radius: 8px;
  max-width: 400px;
}

.github-card {
	background: transparent;
	margin: 0 0 0 20px;
}

.music-card {
  background: transparent;
  margin: 0 0 5px 20px; /* Adjusted margins to reduce space */
  padding: 5px; /* Reduced padding */
}

/* Information about the timeline */
.info {
}

/* Title of the card */
.title {
  position: relative;
}

/* Timeline dot */
.card::before {
  content: "";
  position: absolute;
  width: 20px;
  height: 25px;
  background: var(--background-color);
  border-radius: 999px;
  left: -29px;
  border: 3px solid var(--background-color);
}

.post-icon {
  position: absolute;
  width: 25px;  /* Adjust the width as needed */
  height: 25px; /* Adjust the height as needed */
  left: -38px;  /* Adjust the position as needed */
  top: 10px;
  margin: 5px;
  color: var(--text-color-link-visited);
}

.fediverse-post-icon {
	position: absolute;
  width: 25px;  /* Adjust the width as needed */
  height: 25px; /* Adjust the height as needed */
  left: -38px;  /* Adjust the position as needed */
  top: 13px;
  margin: 5px;
  color: var(--text-color-link-visited);
}

.pixelfed-icon {
	position: absolute;
  width: 32px;  /* Adjust the width as needed */
  height: 32px; /* Adjust the height as needed */
  left: -42px;  /* Adjust the position as needed */
  top: 7px;
  margin: 5px;
  color: var(--text-color-link-visited);
}

.running-icon {
	position: absolute;
  width: 28px;  /* Adjust the width as needed */
  height: 28px; /* Adjust the height as needed */
  left: -40px;  /* Adjust the position as needed */
  top: 12px;
  margin: 5px;
  color: var(--text-color-link-visited);
}


.music-icon {
	position: absolute;
  width: 28px;  /* Adjust the width as needed */
  height: 28px; /* Adjust the height as needed */
  left: -40px;  /* Adjust the position as needed */
  top: 7px;
  margin: 5px;
  color: var(--text-color-link-visited);
}

.post-date {
  background: rgba(0, 0, 0, 0.1); 
  padding: 5px 10px;
  border-radius: 4px;
	font-size: 0.55em;
}

.post-media {
  max-width: 100%;
  height: auto; 
  border-radius: 8px;
  display: block;
}

.notvisible {
	display: none;
}</style>

		
		<!-- OpenGraph Meta Tags -->
		<meta property="og:title" content="Experimenting with ActivityPub: Minetest ActivityPub Bridge - Tom Casavant">
		<meta property="og:description" content="Blog about things">
		
		  <meta property="og:image" content="/img/opengraph/opengraph.png">
		
		
		<meta property="og:url" content="/experimenting-with-activitypub-minetest-activitypub-bridge/">
		<meta property="og:type" content="article">
		<meta property="og:site_name" content="Tom Casavant">
	</head>
	<body>

		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>

		<style>
		  .h-card {
		    display: none;
		  }
		</style>
	
		<span class="h-card">
		  <a class="u-url" rel="me" href="/img/images/tomface.png">Tom Casavant</a>
		  <img class="u-photo" src="/img/images/tomface.png" />
			<img class="u-featured" src="img/opengraph/opengraph.png" />
		</span>

			<a href="/" class="home-link">Tom Casavant</a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
					<li class="nav-item"><a href="/bookmarks/">Bookmarks</a></li>
					<li class="nav-item"><a href="/feeds/">Feeds</a></li>
					<li class="nav-item"><a href="/food/">Food</a></li>
					<li class="nav-item"><a href="/photography/">Photography</a></li>
					<li class="nav-item"><a href="/running/">Running</a></li>
					<li class="nav-item"><a href="/blogroll/">Blogroll</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			

<article class="h-entry">
    <h1 class="p-name">Experimenting with ActivityPub: Minetest ActivityPub Bridge</h1>

    <ul class="post-metadata">
        <li><time class="dt-published" datetime="2024-03-14">14 March 2024</time></li>
    </ul>

    <div class="e-content">
        <p>I've found the easiest way to learn how software works is to try and do something stupid with it.</p>
<p>ActivityPub is a decentralized social networking protocol and is the thing that lets Mastodon servers communicate with Pixelfed servers communicate with Threads communicate with Flipboard and on and on.
I've done <a href="/the-problem-with-hashtags">a bit</a> of <a href="https://github.com/TomCasavant/tom-postmarks">development</a> on servers that <em>use</em> ActivityPub but I have never dealt with the protocol itself.</p>
<p><em>until now.</em></p>
<p><a href="https://www.minetest.net/">Minetest</a> is an &quot;open source voxel game engine&quot; and is designed to make modding very simple. Copy a few files into the <code>mods/</code> directory and suddenly you're executing lua code from within the game.
It also has an in-game chat window for communicating with other players on a given server.</p>
<p>But what if it could do more than that? What if you could send and receive messages from anyone and anywhere?</p>
<p>&quot;But Tom,&quot; you ask, &quot;won't that just clog up the chat with pointless messages from strangers?&quot;
And yes, you would be correct. But (TODO: COME UP WITH REASON WHY THIS IS USEFUL).</p>
<h2 id="the-plan" tabindex="-1">The Plan <a class="header-anchor" href="#the-plan">#</a></h2>
<p>For reasons other than this project I have already been looking for an ActivityPub server that will let me generate users at-will. Most servers are designed for users so they require you to add emails and passwords and useless junk that I do not care about.
Having failed to find anything that would suit my needs I created <a href="https://github.com/TomCasavant/DynamicActivityPub/">this project</a> which would allow me to split this project into 2 parts.</p>
<ol>
<li>The Server - A basic ActivityPub server with endpoints for creating Users, Groups, and generating ActivityPub compatible messages</li>
<li>The Mod - A Lua minetest mod that communicates with the server, when a user sends a message upload it to the server. When the server receives a message it should send that to the chat through this mod.</li>
</ol>
<p>I had considered implementing the server in Lua so it could be built into the mod itself, but as far as I could find Minetest won't let me create web enpoints from the mod (the <a href="https://content.minetest.net/packages/heger/webchat/">few mods</a> where that would be useful just have a separate server that the user has to setup the files for)</p>
<h2 id="activitypub-implementation" tabindex="-1">ActivityPub Implementation <a class="header-anchor" href="#activitypub-implementation">#</a></h2>
<p>This was by far the harder of the 2 portions of the project, primarily because there is <em>not</em> a lot of documentation for this protocol.</p>
<p>Well, that's not entirely true. <a href="https://www.w3.org/TR/activitypub/">w3</a> has some very detailed descriptions which were incredibly useful, but the protocol is defined slightly differently from server-to-server. So something that mastodon is able to understand and accept doesn't necessarily show up on an <a href="https://github.com/MbinOrg/mbin">Mbin</a> server unless certain requirements are met.</p>
<p>Getting a basic account to be discoverable was actually VERY easy. The base protocol calls for an endpoint for each user that returns json with a few attributes, Mastodon (and most others from what I've seen) require slightly more information including a <code>publicKey</code> and <code>preferredUsername</code>.
A JSON request to that endpoint ends up returning something like this:</p>
<pre class="language-json" tabindex="0"><code class="language-json">https<span class="token operator">:</span><span class="token comment">//activitypubtesting.duckdns.org/users/testUser1</span>
<span class="token punctuation">{</span>
    <span class="token property">"@context"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"https://www.w3.org/ns/activitystreams"</span><span class="token punctuation">,</span>
                <span class="token string">"https://w3id.org/security/v1"</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"id"</span><span class="token operator">:</span> f<span class="token string">"https://activitypubtesting.duckdns.org/users/testUser1"</span><span class="token punctuation">,</span>
            <span class="token property">"inbox"</span><span class="token operator">:</span> f<span class="token string">"https://activitypubtesting.duckdns.org/users/testUser1/inbox"</span><span class="token punctuation">,</span>
            <span class="token property">"outbox"</span><span class="token operator">:</span> f<span class="token string">"https://activitiypubtesting.duckdns.org/users/testUser1/outbox"</span><span class="token punctuation">,</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"Person"</span><span class="token punctuation">,</span>
            <span class="token property">"name"</span><span class="token operator">:</span> f<span class="token string">"Test User 1"</span><span class="token punctuation">,</span>
            <span class="token property">"preferredUsername"</span><span class="token operator">:</span> f<span class="token string">"testUser1"</span><span class="token punctuation">,</span>
            <span class="token property">"publicKey"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"id"</span><span class="token operator">:</span> f<span class="token string">"https://activitypubtesting.duckdns.org/users/testUser1#main-key"</span><span class="token punctuation">,</span>
                <span class="token property">"owner"</span><span class="token operator">:</span> f<span class="token string">"https://activitypubtesting.duckdns.org/users/testUser1"</span><span class="token punctuation">,</span>
                <span class="token property">"publicKeyPem"</span><span class="token operator">:</span> THE PUBLIC KEY GENERATED FOR THIS USER
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span></code></pre>
<p>There are other optional components to this which would show up differently for different servers. If you added <code>attachments</code>, for example, Mastodon would display these as profile fields.
Essentially whenever an ActivityPub server needs to obtain information about a user it uses the JSON data from this endpoint to discover where to send data to and where to pull data from.</p>
<p>We can also (optionally) define a webfinger endpoint. This just lets other servers find the /users/ endpoint where a user profile is located and is always at /.well-known/webfinger.
You can experiment with webfingers here: https://webfinger.net/ and just search for <code>@your_username@yourserver.com</code></p>
<p>Next (because it seemed far easier than posting messages) was following a user and receiving messages. All you need to receiver a message from another server is the <code>inbox</code> endpoint. There's no special activitypub stuff we have to do here, this just receives data from a server (my assumption is that most servers do some verification steps here whenever data is received, but I have not done that).
But, no messages will be sent to you <em>unless</em> you instruct other servers to talk to you.</p>
<p>This is where I ran into my first hurdle- cryptographic signatures. The purpose for these is to help servers have confidence that the server that's sending you data is who they say they are.
There are far more experienced people out there who can explain in detail how these work, but in simple terms this is the process:</p>
<ul>
<li>Server A generates a private key, which looks like this, then saves this and never tells anyone what this is ever:</li>
</ul>
<pre><code>-----BEGIN RSA PRIVATE KEY-----
MIIBOgIBAAJBAKj34GkxFhD90vcNLYLInFEX6Ppy1tPf9Cnzj4p4WGeKLs1Pt8Qu
KUpRKfFLfRYC9AIKjbJTWit+CqvjWYzvQwECAwEAAQJAIJLixBy2qpFoS4DSmoEm
o3qGy0t6z09AIJtH+5OeRV1be+N4cDYJKffGzDa88vQENZiRm0GRq6a+HPGQMd2k
TQIhAKMSvzIBnni7ot/OSie2TmJLY4SwTQAevXysE2RbFDYdAiEBCUEaRQnMnbp7
9mxDXDf6AU0cN/RPBjb9qSHDcWZHGzUCIG2Es59z8ugGrDY+pxLQnwfotadxd+Uy
v/Ow5T0q5gIJAiEAyS4RaI9YG8EWx/2w0T67ZUVAw8eOMB6BIUg0Xcu+3okCIBOs
/5OiPgoTdSy7bcF9IGpSE8ZgGKzgYQVZeN97YE00
-----END RSA PRIVATE KEY-----
</code></pre>
<ul>
<li>Server A then uses that private key to generate a public key (this public key is what we store on the /users/ endpoint). Which looks like this:</li>
</ul>
<pre><code>-----BEGIN RSA PUBLIC KEY-----
MEgCQQCo9+BpMRYQ/dL3DS2CyJxRF+j6ctbT3/Qp84+KeFhnii7NT7fELilKUSnx
S30WAvQCCo2yU1orfgqr41mM70MBAgMBAAE=
-----END RSA PUBLIC KEY----
</code></pre>
<p>*Note: I didn't do any deep work with these, there's a <a href="https://cryptography.io/en/latest/">python cryptography</a> library that handles generating these</p>
<ul>
<li>Server A creates a message that says '@testUser1@ServerA.com wants to follow @testUser2@ServerB.com'</li>
<li>Before sending that message Server A retrieves our private key from before and uses it to encrypt the message.</li>
<li>Server B receives the encrypted message and uses the publicKey from the /users/ endpoint to decrypt it</li>
<li>if Server B determines that private key that signed this message is the same private key that signed the public key then it accepts it as a genuine request and will now start sending @testUser2's posts to @testUser1's inbox</li>
</ul>
<p>There was <em>A LOT</em> of trial and error trying to get this to work properly after building this function to test my public key I learned most of my issues were because I was incorrectly returning the publicKey in the /users/ endpoint so anything sent couldn't be verified</p>
<pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">def</span> <span class="token function">verification_testing</span><span class="token punctuation">(</span>public_key_url<span class="token punctuation">,</span> private_key<span class="token punctuation">,</span> raw_signature<span class="token punctuation">,</span> signature_text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Load the public key JSON from the user's URL</span>
    public_key_response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>public_key_url<span class="token punctuation">)</span>
    public_key_json <span class="token operator">=</span> public_key_response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'publicKey'</span><span class="token punctuation">]</span>

    <span class="token comment"># Extract the public key from the JSON</span>
    public_key_pem <span class="token operator">=</span> public_key_json<span class="token punctuation">[</span><span class="token string">'publicKeyPem'</span><span class="token punctuation">]</span>

    <span class="token comment"># Load the public key</span>
    public_key <span class="token operator">=</span> serialization<span class="token punctuation">.</span>load_pem_public_key<span class="token punctuation">(</span>
        public_key_pem<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        backend<span class="token operator">=</span>crypto_default_backend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        public_key<span class="token punctuation">.</span>verify<span class="token punctuation">(</span>
            raw_signature<span class="token punctuation">,</span>
            signature_text<span class="token punctuation">,</span>
            padding<span class="token punctuation">.</span>PKCS1v15<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            hashes<span class="token punctuation">.</span>SHA256<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Signature verification successful"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Signature verification failed: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></code></pre>
<p>After this I was now able to follow users and messages were flowing in. Fortunately for us, the process of signing messages is identical whenever a message has to be signed.
Setting up followers was pretty easy (or so I thought). Essentially in the user/inbox/ endpoint we check the data received for 'Follow', and then process the information there (<em>again</em> you should probably be doing the cryptographic verification of their signatures but I did not).
I learned during this that Mastodon requires that you send a signed 'Accept' message or else they won't treat the follow as successful.</p>
<p>Posting messages is pretty straight-forward, you just have to loop through all the users that follow you and send the signed message to their inboxes. My create message endpoint generates the user if it doesn't already exist in the server (since we will need to generate users for each Minetest user that exists)</p>
<p>The last ActivityPub type I messed around with was Group. Unlike the user (or Person) entity, there is not a very unified description of how a group functions.
Through some experimentation in <a href="https://activitypub.academy/">https://activitypub.academy</a> I learned that Lemmy's groups just send Announce activities to mastodon (which mastodon displays as boosts), but I believe they're a little more complex when a lemmy community talks with another server that actually supports groups.</p>
<p>I didn't delve that much into it, I just need to create a Group entity that boosts all of the messages from each individual user that way you can see a feed of all the server messages.</p>
<h2 id="minetest" tabindex="-1">Minetest <a class="header-anchor" href="#minetest">#</a></h2>
<p>Don't worry, this a much shorter topic. A minetest mod consists of 2 files (mine consists of 3), the init.lua and hte mod.conf.
mod.conf just defines what a plugin is and allows you to set configuration variables.
init.lua contains the lua script that interacts with the minetest server.</p>
<p>I also added in a json.lua file which I copied in that makes the JSON requests we have to make easier.</p>
<p>There's basically just 2 things we need to do in this file</p>
<ul>
<li>Send all new messages to the activitypub server</li>
<li>And retrieve new messages (ideally, the server would just send message whenever a new one comes in but as I mentioned before I can't create an enpoint in the mod)</li>
</ul>
<p>Minetest's built-in API lets me use <code>minetest.register_on_chat_message()</code> to call a function whenever a new chat message is entered. So, I just take that message and send it to my activitypub server:</p>
<pre class="language-lua" tabindex="0"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">new_message</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
    minetest<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">,</span> <span class="token string">"Sending JSON data: "</span> <span class="token operator">..</span> player<span class="token punctuation">)</span>
    <span class="token keyword">local</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>message <span class="token operator">=</span> msg<span class="token punctuation">,</span> username <span class="token operator">=</span> player<span class="token punctuation">,</span> groups <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"minetest"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> api_key<span class="token operator">=</span><span class="token string">"temporary"</span><span class="token punctuation">}</span>
    <span class="token keyword">local</span> json_data <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    minetest<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">,</span> <span class="token string">"Sending JSON data: "</span> <span class="token operator">..</span> json_data<span class="token punctuation">)</span>

    <span class="token keyword">local</span> url <span class="token operator">=</span> <span class="token string">"http://192.168.1.75:9999/api/create_message"</span>  <span class="token comment">-- Replace with your actual URL</span>
 
    http<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url <span class="token operator">=</span> url<span class="token punctuation">,</span>
        method <span class="token operator">=</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
        data <span class="token operator">=</span> json_data<span class="token punctuation">,</span>
        extra_headers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"Content-Type:application/json"</span> <span class="token punctuation">}</span>
        <span class="token comment">--    ["Content-Type"] = "application/json",</span>
        <span class="token comment">--    ["Content-Length"] = tostring(#json_data)</span>
        <span class="token comment">--}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The activitypub server will then post the message (and create the user) under the user's identity.</p>
<p>Finally, we have to receive messages from our ActivityPub server. My solution for this was just identical to the web chat <a href="https://content.minetest.net/packages/heger/webchat/">mod</a> where we'll regularly poll our server and check if there are any new messages, if there are new messages we send them directly to the in-game chat.</p>
<pre class="language-lua" tabindex="0"><code class="language-lua"><span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">poll_messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> url <span class="token operator">=</span> <span class="token string">"http://192.168.1.75:9999/api/get_recent_messages?last_id="</span> <span class="token operator">..</span> last_message_id
    http<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url <span class="token operator">=</span> url<span class="token punctuation">,</span>
        method <span class="token operator">=</span> <span class="token string">"GET"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>succeeded <span class="token keyword">then</span>
            <span class="token keyword">local</span> messages <span class="token operator">=</span> minetest<span class="token punctuation">.</span><span class="token function">parse_json</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
            <span class="token keyword">if</span> messages <span class="token keyword">then</span>
                <span class="token keyword">for</span> _<span class="token punctuation">,</span> message <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span> <span class="token keyword">do</span>
                    <span class="token comment">-- Check if message ID is greater than last_message_id</span>
                    <span class="token keyword">if</span> message<span class="token punctuation">.</span>id <span class="token operator">></span> last_message_id <span class="token keyword">then</span>
                        minetest<span class="token punctuation">.</span><span class="token function">chat_send_all</span><span class="token punctuation">(</span><span class="token string">"[ActivityPub] "</span> <span class="token operator">..</span> message<span class="token punctuation">.</span>username <span class="token operator">..</span> <span class="token string">": "</span> <span class="token operator">..</span> message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
                        last_message_id <span class="token operator">=</span> message<span class="token punctuation">.</span>id
                    <span class="token keyword">end</span>
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>
        <span class="token keyword">else</span>
            minetest<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"Failed to fetch messages from ActivityPub server"</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-- Call the poll_messages function periodically</span>
minetest<span class="token punctuation">.</span><span class="token function">register_globalstep</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>dtime<span class="token punctuation">)</span>
    <span class="token comment">-- Poll every 10 seconds (adjust as needed)</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token function">poll_messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span class="token punctuation">)</span></code></pre>
<p>And this is it in action:</p>
<div class="video-container">
  <video controls="">
    <source src="/video/minetest_demo.webm" type="video/webm">
    Your browser does not support the video tag.
  </video>
</div>
<h2 id="issues" tabindex="-1">Issues <a class="header-anchor" href="#issues">#</a></h2>
<p>This was all to experiment with ActivityPub, but I didn't do anything to secure the server. All private keys are stored unencrypted in a sqlite database, most of the endpoints that generate users and posts are not secured by any form of authentication.</p>
<p>I wasn't able to find much information about testing an activitypub server. I'm sure there's some way to locally run a mastodon server to test against, it feels incorrect to publicly host a website in development just to test my ActivityPub implementation.</p>
<p><a href="https://github.com/TomCasavant/DynamicActivityPub">ActivityPub Server repo</a>
<a href="https://github.com/TomCasavant/MinetestActivityPub">Minetest Mod Repo</a></p>

    </div>

    <a href="/experimenting-with-activitypub-minetest-activitypub-bridge/" class="u-url"></a>
    <ul class="links-nextprev"><li>Previous: <a href="/the-problem-with-hashtags/">The Problem with Hashtags</a></li><li>Next: <a href="/tomline/">Tomline</a></li>
    </ul>

		<a class="u-bridgy-fed" href="https://fed.brid.gy/" hidden="from-humans"></a>
</article>

<section>  
  <h2>Webmentions</h2>  
  
  <div class="webmentions content-grid-sibling" id="webmentions">

  
  
  
  
  
  
  


<div class="webmentions__facepile">
  <h3>1
    Like</h3>

    

      
        <a class="h-card u-url link-u-exempt" href="https://ap.brid.gy/convert/web/https://mastodon.social/users/cauanzorzenon%23likes/171890695" target="_blank" rel="noopener noreferrer">
      

      
      <img src="https://webmention.io/avatar/files.mastodon.social/432ff08ec4555d1cfe7b0907be1cb0111f0d8079385c1bf8d3b844b7500c2f3e.jpg" alt="Cauan Henrique Zorzenon" width="48" height="48" loading="lazy">
      

      
        </a>
      
    
</div>



<div class="webmentions__facepile">
  <h3>1 Retweet</h3>

    
      
      <a class="h-card u-url link-u-exempt" href="https://ap.brid.gy/convert/web/https://tomkahe.com/users/tom/statuses/112836369183174172/activity" target="_blank" rel="noopener noreferrer">
      

      
      <img src="https://webmention.io/avatar/s3.us-east-2.amazonaws.com/96e6f33aca9c9d847e9069fce6096d3430ac48893309a3b73a61da3733cbe24c.jpg" alt="Tom Casavant" width="48" height="48" loading="lazy">
      
      
      </a>
      
    
</div>




<p>These are <a href="https://indieweb.org/Webmention">webmentions</a> via the <a href="https://indieweb.org/">IndieWeb</a> and <a href="https://webmention.io/">webmention.io</a>. Mention this post from your site:</p>

<form action="https://webmention.io/tomcasavant.com/webmention" method="post" class="form-webmention">
    <label for="form-webmention-source">URL</label><br>
    <input id="form-webmention-source" type="url" name="source" placeholder="https://example.com" required>
    <input type="hidden" name="target" value="https://tomcasavant.com/experimenting-with-activitypub-minetest-activitypub-bridge/">
    <input type="submit" class="button button-small" value="Send Webmention">
  </form>
</div>

</section>


		</main>

		<footer></footer>

		<!-- This page `/experimenting-with-activitypub-minetest-activitypub-bridge/` was built on 2024-11-19T21:41:43.192Z -->
	</body>
</html>
